[base]
# set the python package name for use in other sections
name = .

[tox]
# 3.1.0 required for ignore_basepython_conflict
minversion = 3.1.0
isolated_build = true

# always use the python version specified in the environment name
ignore_basepython_conflict = true

# set which envs are run when tox is used with no args (e.g. from PyCharm)
envlist = py310, build, lint

[testenv]
passenv =
    CI_PIPELINE_ID
    DJANGO_*
    POSTGRES_*
skip_install = true
setenv =
    PIP_EXTRA_INDEX_URL = https://repo.bodc.me/repository/pypi-bodc/simple/
extras = test
allowlist_externals = poetry
commands_pre =
    poetry install --no-root --with lint,test
commands =
    coverage run --source {[base]name} \
      --data-file=coverage_reports/.coverage \
      --omit api/tests/*,api/migrations/*,api/schema.py,config/*,manage.py \
      manage.py test api/tests --verbosity 2
    coverage report --data-file=coverage_reports/.coverage -m --skip-covered
    coverage xml --data-file=coverage_reports/.coverage -o coverage_reports/coverage.xml

[testenv:lint]
allowlist_externals = poetry
commands_pre =
    poetry install --no-root --with test,lint
commands =
    ruff format --diff {[base]name}
    ruff check {[base]name}

[testenv:build]
allowlist_externals = poetry
commands_pre =
    poetry install --no-root --with build
commands =
    poetry self add "poetry-dynamic-versioning[plugin]"
    poetry build
    twine check dist/*


[testenv:format]
allowlist_externals = poetry
commands_pre =
    poetry install --no-root --with lint
commands =
    ruff format {[base]name}
    ruff check --fix {[base]name}


[testenv:types]
allowlist_externals = poetry
commands_pre =
    poetry install --no-root --with test,lint
commands =
    pyright {[base]name}
